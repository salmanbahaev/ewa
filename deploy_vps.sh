#!/bin/bash
# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ñ EWA Bot Ð½Ð° VPS
# Ð—Ð°Ð¿ÑƒÑÐº: bash deploy_vps.sh

set -e

echo "=========================================="
echo "ðŸš€ Ð”ÐµÐ¿Ð»Ð¾Ð¹ EWA Product Telegram Bot"
echo "=========================================="
echo ""

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Python
echo "ðŸ“¦ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Python..."
if ! command -v python3 &> /dev/null; then
    echo "âŒ Python3 Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°..."
    sudo apt update
    sudo apt install python3 python3-pip python3-venv -y
fi

PYTHON_VERSION=$(python3 --version)
echo "âœ… $PYTHON_VERSION ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
echo ""

# ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
CURRENT_USER=$(whoami)
BOT_DIR=$(pwd)

echo "ðŸ‘¤ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ: $CURRENT_USER"
echo "ðŸ“ Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ: $BOT_DIR"
echo ""

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
echo "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ..."
if [ ! -d "venv" ]; then
    python3 -m venv venv
    echo "âœ… Ð’Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¾"
else
    echo "âœ… Ð’Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
fi

# ÐÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
source venv/bin/activate
echo "ðŸ“¥ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
pip install -r requirements.txt --quiet
echo "âœ… Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"
echo ""

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° .env Ñ„Ð°Ð¹Ð»Ð°
echo "ðŸ”‘ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸..."
if [ ! -f ".env.local" ] && [ ! -f ".env" ]; then
    echo "âš ï¸  Ð¤Ð°Ð¹Ð» .env Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
    echo "Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ .env.local Ñ Ñ‚Ð¾ÐºÐµÐ½Ð°Ð¼Ð¸:"
    echo ""
    echo "TELEGRAM_BOT_TOKEN=Ð²Ð°Ñˆ_Ñ‚Ð¾ÐºÐµÐ½"
    echo "OPENAI_API_KEY=Ð²Ð°Ñˆ_ÐºÐ»ÑŽÑ‡"
    echo ""
    read -p "Ð¥Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ ÑÐµÐ¹Ñ‡Ð°Ñ? (y/n): " create_env
    if [ "$create_env" = "y" ]; then
        read -p "Telegram Bot Token: " bot_token
        read -p "OpenAI API Key: " openai_key
        cat > .env.local << EOF
TELEGRAM_BOT_TOKEN=$bot_token
OPENAI_API_KEY=$openai_key
OPENAI_MODEL=gpt-4o-mini
DATABASE_PATH=data/bot_database.db
LOG_LEVEL=INFO
LOG_DIR=logs
EOF
        chmod 600 .env.local
        echo "âœ… ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð°"
    else
        echo "âŒ Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ .env.local Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð¸ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ ÑÐ½Ð¾Ð²Ð°"
        exit 1
    fi
else
    echo "âœ… ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°"
fi
echo ""

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ systemd service
echo "âš™ï¸  ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° systemd service..."
SERVICE_FILE="/etc/systemd/system/ewa-bot.service"

sudo tee $SERVICE_FILE > /dev/null << EOF
[Unit]
Description=EWA Product Telegram Bot
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=$CURRENT_USER
WorkingDirectory=$BOT_DIR
ExecStart=$BOT_DIR/venv/bin/python $BOT_DIR/main.py

# ÐÐ²Ñ‚Ð¾Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº
Restart=always
RestartSec=10

# ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ Ð½Ð° Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ¸ (Ð·Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ Ð±ÐµÑÐºÐ¾Ð½ÐµÑ‡Ð½Ð¾Ð³Ð¾ Ñ†Ð¸ÐºÐ»Ð°)
StartLimitInterval=300
StartLimitBurst=5

# Environment
Environment="PYTHONUNBUFFERED=1"

# Logging
StandardOutput=journal
StandardError=journal
SyslogIdentifier=ewa-bot

# Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ Ð¸ Ñ€ÐµÑÑƒÑ€ÑÑ‹
Nice=0
CPUQuota=50%
MemoryLimit=512M

[Install]
WantedBy=multi-user.target
EOF

echo "âœ… Service Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½: $SERVICE_FILE"
echo ""

# ÐÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ Ð¸ Ð·Ð°Ð¿ÑƒÑÐº
echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°..."
sudo systemctl daemon-reload
sudo systemctl enable ewa-bot
sudo systemctl restart ewa-bot

# ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ°
sleep 3

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
if sudo systemctl is-active --quiet ewa-bot; then
    echo "âœ… Ð‘Ð¾Ñ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!"
    echo ""
    echo "=========================================="
    echo "âœ¨ Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"
    echo "=========================================="
    echo ""
    echo "ðŸ“Š Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð±Ð¾Ñ‚Ð¾Ð¼:"
    echo "   sudo systemctl status ewa-bot    # Ð¡Ñ‚Ð°Ñ‚ÑƒÑ"
    echo "   sudo systemctl restart ewa-bot   # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº"
    echo "   sudo systemctl stop ewa-bot      # ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°"
    echo "   sudo journalctl -u ewa-bot -f    # Ð›Ð¾Ð³Ð¸ Ð² Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸"
    echo ""
else
    echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð±Ð¾Ñ‚Ð°!"
    echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸: sudo journalctl -u ewa-bot -n 50"
    exit 1
fi

